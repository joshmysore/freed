<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freed: Event and Food Finder</title>
    <style>
        :root {
            --primary-dark: #0f0f0f;
            --secondary-dark: #1a1a1a;
            --tertiary-dark: #2d2d2d;
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            --text-light-gray: #d0d0d0;
            --accent-orange: #ff6b35;
            --accent-orange-light: #ff8c5a;
            --border-gray: #404040;
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --gradient-primary: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-orange-light) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-gray);
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--text-white);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .triangle-1, .triangle-2 {
            position: absolute;
            width: 0;
            height: 0;
            transition: all 0.3s ease;
        }

        .triangle-1 {
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 35px solid var(--accent-orange);
            top: 0;
            left: 0;
        }

        .triangle-2 {
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 35px solid var(--accent-orange-light);
            top: 5px;
            left: 10px;
            opacity: 0.8;
        }

        .logo:hover .triangle-1 {
            transform: rotate(5deg);
        }

        .logo:hover .triangle-2 {
            transform: rotate(-5deg);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--accent-orange);
        }

        /* Hero Section */
        .hero {
            padding: 8rem 2rem 4rem;
            text-align: center;
            background: radial-gradient(ellipse at center, rgba(255, 107, 53, 0.1) 0%, transparent 70%);
        }

        .hero-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-gray);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-cta {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: var(--tertiary-dark);
            color: var(--text-white);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
            border-color: var(--accent-orange);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .content-section {
            background: var(--secondary-dark);
            border-radius: 16px;
            border: 1px solid var(--border-gray);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-gray);
            background: var(--tertiary-dark);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--text-gray);
            font-size: 1rem;
        }

        .controls {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-light-gray);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 1rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            color: var(--text-white);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
        }

        .btn-food {
            background: #10b981;
            color: white;
        }

        .btn-food:hover {
            background: #059669;
        }

        .btn-food.active {
            background: #047857;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .btn-calendar {
            background: var(--accent-orange);
            color: white;
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
        }

        .btn-calendar:hover {
            background: var(--accent-orange-light);
            transform: translateY(-1px);
        }

        /* Status Messages */
        .status {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
            border-left: 4px solid;
        }

        .status.loading {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-color: #3b82f6;
            position: relative;
            overflow: hidden;
        }

        .status.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: loading-shimmer 2s infinite;
        }

        @keyframes loading-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border-color: #10b981;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border-color: #ef4444;
        }

        /* Events Display */
        .events-container {
            display: grid;
            gap: 1rem;
        }

        .date-group {
            background: var(--secondary-dark);
            border-radius: 12px;
            border: 1px solid var(--border-gray);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .date-header {
            background: var(--tertiary-dark);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-gray);
            font-weight: 600;
            color: var(--text-light-gray);
            font-size: 1.1rem;
        }

        .event-card {
            border-bottom: 1px solid var(--border-gray);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .event-card:hover {
            background: var(--tertiary-dark);
        }

        .event-card:last-child {
            border-bottom: none;
        }

        .event-card.expanded {
            background: var(--tertiary-dark);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .event-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .event-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 0.5rem;
            flex: 1;
        }

        .event-time {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .event-location {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .event-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-category {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-cuisine {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .badge-confidence {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-food {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-mailing-list {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-url {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .expand-icon {
            color: var(--text-gray);
            transition: transform 0.3s ease;
            margin-left: auto;
        }

        .event-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .event-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-gray);
        }

        .event-card.expanded .event-details {
            display: block;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light-gray);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: var(--text-gray);
        }

        .urls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .url-link {
            color: var(--accent-orange);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .url-link:hover {
            color: var(--accent-orange-light);
            text-decoration: underline;
        }

        .contacts {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .contact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .contact-email {
            color: var(--accent-orange);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .contact-email:hover {
            text-decoration: underline;
        }

        /* About Section */
        .about-section {
            display: none;
            padding: 2rem;
        }

        .about-section.active {
            display: block;
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .about-content h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .about-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-light-gray);
        }

        .about-content p {
            color: var(--text-gray);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .feature-list {
            list-style: none;
            margin-bottom: 2rem;
        }

        .feature-list li {
            color: var(--text-gray);
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .feature-list li::before {
            content: "✨";
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Loading and Empty States */
        .loading, .empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-gray);
        }

        .hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .hero {
                padding: 6rem 1rem 3rem;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero-cta {
                flex-direction: column;
                align-items: center;
            }

            .main-content {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Progress Animation */
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .progress-bar {
            margin-top: 10px;
            background: var(--border-gray);
            border-radius: 4px;
            height: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: var(--accent-orange);
            height: 100%;
            width: 0%;
            animation: progress 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo" onclick="showHomePage()">
                <div class="logo-icon">
                    <div class="triangle-1"></div>
                    <div class="triangle-2"></div>
                </div>
                <span class="logo-text">Freed</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" onclick="showHomePage()" class="nav-link active" data-page="home">Events</a></li>
                <li><a href="#" onclick="showAboutPage()" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Event and Food Finder</h1>
            <p>Discover campus events and delicious food from your mailing lists with AI-powered parsing and smart categorization.</p>
            <div class="hero-cta">
                <button onclick="showHomePage()" class="btn btn-primary">
                    🔍 Browse Events
                </button>
                <button onclick="showAboutPage()" class="btn btn-secondary">
                    📖 Learn More
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Home Page -->
        <div id="homePage" class="content-section">
            <div class="section-header">
                <h2 class="section-title">🎉 Upcoming Events</h2>
                <p class="section-subtitle">Discover events from your mailing lists with intelligent food and category detection</p>
            </div>
            
            <div class="controls">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="dateFilter">Filter by Date:</label>
                        <input type="date" id="dateFilter">
                    </div>
                    
                    <div class="form-group">
                        <label for="mailingListFilter">Filter by Mailing List:</label>
                        <select id="mailingListFilter">
                            <option value="">All Mailing Lists</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryFilter">Filter by Category:</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cuisineFilter">Filter by Cuisine:</label>
                        <select id="cuisineFilter">
                            <option value="">All Cuisines</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="loadEvents()" id="loadBtn" class="btn btn-primary btn-small">
                        🔄 Load Events
                    </button>
                    <button onclick="toggleFoodFilter()" id="foodBtn" class="btn btn-food btn-small">
                        🍕 Food Only
                    </button>
                    <button onclick="clearFilters()" id="clearBtn" class="btn btn-secondary btn-small">
                        🗑️ Clear Filters
                    </button>
                </div>
                
                <p style="margin-top: 1rem; color: var(--text-gray); font-size: 0.9rem;">
                    Processing up to 100 recent mailing list emails with AI to extract event information. 
                    Only click "Load Events" when you want to refresh the data.
                </p>
            </div>
            
            <div id="status" class="status hidden"></div>
            <div id="eventsContainer" class="events-container"></div>
        </div>

        <!-- About Page -->
        <div id="aboutPage" class="about-section">
            <div class="about-content">
                <h2>About Freed</h2>
                <p>
                    Freed is an intelligent event and food discovery platform that automatically parses your mailing list emails 
                    to extract event information, categorize activities, and identify food offerings. Built with AI-powered 
                    natural language processing, it transforms cluttered inboxes into organized event calendars.
                </p>

                <h3>🚀 Key Features</h3>
                <ul class="feature-list">
                    <li><strong>AI-Powered Parsing:</strong> Uses advanced language models to extract structured event data from unstructured email content</li>
                    <li><strong>Smart Categorization:</strong> Automatically categorizes events (workshops, lectures, social events, etc.) with confidence scoring</li>
                    <li><strong>Food Detection:</strong> Identifies food offerings, cuisines, and quantity hints from event descriptions</li>
                    <li><strong>Mailing List Integration:</strong> Seamlessly connects to your Gmail and processes emails from various mailing lists</li>
                    <li><strong>Intelligent Filtering:</strong> Filter events by date, category, cuisine, mailing list, and food availability</li>
                    <li><strong>Modern Interface:</strong> Clean, dark-mode interface with responsive design for all devices</li>
                </ul>

                <h3>🔧 How It Works</h3>
                <p>
                    Freed connects to your Gmail account and scans emails from configured mailing lists. Using advanced AI models, 
                    it analyzes email content to extract event details like titles, descriptions, dates, times, locations, and food information. 
                    The system applies intelligent gating to only process emails that appear to contain event information, ensuring efficiency 
                    and accuracy.
                </p>

                <h3>🎯 Perfect For</h3>
                <ul class="feature-list">
                    <li>Students managing multiple campus mailing lists</li>
                    <li>Event organizers tracking food and logistics</li>
                    <li>Anyone overwhelmed by event-related emails</li>
                    <li>People who want to discover campus activities and food offerings</li>
                </ul>

                <h3>🔒 Privacy & Security</h3>
                <p>
                    Freed processes your emails locally and only stores necessary event data. Your email content is analyzed 
                    by secure AI models and never stored permanently. The system uses OAuth2 for secure Gmail access and 
                    follows best practices for data protection.
                </p>

                <div style="text-align: center; margin-top: 3rem;">
                    <button onclick="showHomePage()" class="btn btn-primary">
                        🎉 Start Discovering Events
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allEvents = [];
        let filteredEvents = [];
        let foodFilterActive = false;
        let currentPage = 'home';
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            loadEvents();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            document.getElementById('mailingListFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('cuisineFilter').addEventListener('change', applyFilters);
        }

        async function loadFilterOptions() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                
                // Load categories
                const categoryFilter = document.getElementById('categoryFilter');
                config.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    categoryFilter.appendChild(option);
                });
                
                // Load cuisines
                const cuisineFilter = document.getElementById('cuisineFilter');
                config.cuisines.forEach(cuisine => {
                    const option = document.createElement('option');
                    option.value = cuisine;
                    option.textContent = cuisine;
                    cuisineFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }
        
        async function loadEvents() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            const eventsContainer = document.getElementById('eventsContainer');
            
            // Reset UI
            status.className = 'status hidden';
            eventsContainer.innerHTML = '';
            loadBtn.disabled = true;
            loadBtn.textContent = '⏳ Processing...';
            
            // Show detailed progress steps
            await showStatus('🔄 Connecting to Gmail...', 'loading');
            
            try {
                // Get filter values
                const categoryFilter = document.getElementById('categoryFilter').value;
                const cuisineFilter = document.getElementById('cuisineFilter').value;
                
                // Build query parameters - use maximum results
                const params = new URLSearchParams();
                params.append('max_results', '100');
                params.append('sort', 'desc');
                if (categoryFilter) params.append('category', categoryFilter);
                if (cuisineFilter) params.append('cuisine', cuisineFilter);
                
                // Update status for each step
                await showStatus('📧 Fetching mailing list emails...', 'loading');
                
                const response = await fetch(`/events/all?${params}`);
                
                await showStatus('🤖 Processing emails with AI...', 'loading');
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load events');
                }
                
                await showStatus('📊 Finalizing results...', 'loading');
                
                if (data.events && data.events.length > 0) {
                    allEvents = data.events;
                    filteredEvents = allEvents;
                    updateMailingListFilter();
                    applyFilters();
                    
                    // Show detailed success message with stats
                    const stats = data.stats || {};
                    const llmCalls = stats.llm_calls_made || 0;
                    const cacheHits = stats.cache_entries_count || 0;
                    
                    showStatus(
                        `✅ Successfully loaded ${data.count} events from mailing lists! ` +
                        `(AI calls: ${llmCalls}, cached: ${cacheHits})`, 
                        'success'
                    );
                } else {
                    showStatus('❌ No events found in mailing list emails.', 'error');
                }
                
            } catch (err) {
                showStatus(`❌ Error: ${err.message}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = '🔄 Load Events';
            }
        }
        
        function updateMailingListFilter() {
            const mailingListFilter = document.getElementById('mailingListFilter');
            const mailingLists = [...new Set(allEvents.map(event => event.mailing_list).filter(Boolean))];
            
            // Clear existing options except "All Mailing Lists"
            mailingListFilter.innerHTML = '<option value="">All Mailing Lists</option>';
            
            // Add mailing list options
            mailingLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list;
                option.textContent = list;
                mailingListFilter.appendChild(option);
            });
        }
        
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const mailingListFilter = document.getElementById('mailingListFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const cuisineFilter = document.getElementById('cuisineFilter').value;
            
            let filtered = allEvents;
            
            // Filter by date
            if (dateFilter) {
                filtered = filtered.filter(event => event.date_start === dateFilter);
            }
            
            // Filter by mailing list
            if (mailingListFilter) {
                filtered = filtered.filter(event => event.mailing_list === mailingListFilter);
            }
            
            // Filter by category
            if (categoryFilter) {
                filtered = filtered.filter(event => event.category === categoryFilter);
            }
            
            // Filter by cuisine
            if (cuisineFilter) {
                filtered = filtered.filter(event => {
                    if (event.food && event.food.length > 0) {
                        return event.food.some(foodItem => foodItem.cuisine === cuisineFilter);
                    }
                    return false;
                });
            }
            
            // Filter by food
            if (foodFilterActive) {
                filtered = filtered.filter(event => hasFood(event));
            }
            
            filteredEvents = filtered;
            displayEvents();
        }
        
        function hasFood(event) {
            // Check new food structure
            if (event.food && event.food.length > 0) {
                return true;
            }
            
            // Check legacy food_type and food_quantity_hint
            if (event.food_type || event.food_quantity_hint) {
                return true;
            }
            
            // Check description for food keywords
            const foodKeywords = /(pizza|snack|snacks|food|lunch|dinner|breakfast|refreshments|cater(ed|ing)|bagels?|coffee|tea|chai|cookies?)/i;
            return foodKeywords.test(event.description || '');
        }
        
        function toggleFoodFilter() {
            const foodBtn = document.getElementById('foodBtn');
            foodFilterActive = !foodFilterActive;
            
            if (foodFilterActive) {
                foodBtn.classList.add('active');
                foodBtn.textContent = '🍕 Food Only ✓';
            } else {
                foodBtn.classList.remove('active');
                foodBtn.textContent = '🍕 Food Only';
            }
            
            applyFilters();
        }
        
        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('mailingListFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('cuisineFilter').value = '';
            foodFilterActive = false;
            document.getElementById('foodBtn').classList.remove('active');
            document.getElementById('foodBtn').textContent = '🍕 Food Only';
            
            filteredEvents = allEvents;
            displayEvents();
            
            if (allEvents.length > 0) {
                showStatus(`Showing all ${allEvents.length} events`, 'success');
            }
        }
        
        function displayEvents() {
            const container = document.getElementById('eventsContainer');
            
            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="empty">No events match the current filters.</div>';
                return;
            }
            
            // Group events by date
            const groupedEvents = groupEventsByDate(filteredEvents);
            
            // Sort dates
            const sortedDates = Object.keys(groupedEvents).sort();
            
            container.innerHTML = sortedDates.map(date => {
                const events = groupedEvents[date];
                // Sort events within each date by time
                events.sort((a, b) => {
                    const timeA = a.time_start || '23:59';
                    const timeB = b.time_start || '23:59';
                    return timeA.localeCompare(timeB);
                });
                
                return `
                    <div class="date-group">
                        <div class="date-header">${formatDate(date)}</div>
                        ${events.map(event => createEventCard(event)).join('')}
                    </div>
                `;
            }).join('');
        }
        
        function groupEventsByDate(events) {
            return events.reduce((groups, event) => {
                const date = event.date_start;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(event);
                return groups;
            }, {});
        }
        
        function formatDate(dateString) {
            // Create date objects in local timezone for comparison
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Get date strings in YYYY-MM-DD format for comparison
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (dateString === todayStr) {
                return 'Today';
            } else if (dateString === tomorrowStr) {
                return 'Tomorrow';
            } else {
                // Parse the date string and format it
                const [year, month, day] = dateString.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }
        
        function createEventCard(event) {
            const timeStr = formatTimeRange(event.time_start, event.time_end);
            const badges = createBadges(event);
            
            return `
                <div class="event-card" data-event-id="${event.source_message_id}">
                    <div class="event-header">
                        <div class="event-title" onclick="toggleEvent(this.closest('.event-card'))">${event.title}</div>
                        <div class="event-actions">
                            <button onclick="addToGoogleCalendar('${event.source_message_id}', '${event.title.replace(/'/g, "\\'")}')" class="btn btn-calendar" title="Add to Google Calendar">
                                📅 Add to Calendar
                            </button>
                            <div class="expand-icon" onclick="toggleEvent(this.closest('.event-card'))">▼</div>
                        </div>
                    </div>
                    <div class="event-time">${timeStr}</div>
                    <div class="event-location">${event.location || 'Location TBD'}</div>
                    ${badges ? `<div class="event-badges">${badges}</div>` : ''}
                    <div class="event-details">
                        ${createEventDetails(event)}
                    </div>
                </div>
            `;
        }
        
        function formatTimeRange(timeStart, timeEnd) {
            if (!timeStart) return 'Time TBD';
            if (!timeEnd) return timeStart;
            return `${timeStart} - ${timeEnd}`;
        }
        
        function createBadges(event) {
            const badges = [];
            
            if (event.category) {
                badges.push(`<span class="badge badge-category">📋 ${event.category}</span>`);
            }
            
            if (event.confidence && event.confidence.overall) {
                badges.push(`<span class="badge badge-confidence">🎯 ${Math.round(event.confidence.overall * 100)}%</span>`);
            }
            
            if (hasFood(event)) {
                badges.push('<span class="badge badge-food">🍕 Food</span>');
            }
            
            // Add food breakdown if available
            if (event.food && event.food.length > 0) {
                event.food.forEach(foodItem => {
                    if (foodItem.cuisine) {
                        badges.push(`<span class="badge badge-cuisine">🍽️ ${foodItem.cuisine}</span>`);
                    }
                });
            }
            
            if (event.mailing_list) {
                badges.push(`<span class="badge badge-mailing-list">📧 ${event.mailing_list}</span>`);
            }
            
            if (event.urls && event.urls.length > 0) {
                badges.push(`<span class="badge badge-url">🔗 ${event.urls.length} link(s)</span>`);
            }
            
            return badges.join('');
        }
        
        function createEventDetails(event) {
            let details = '';
            
            if (event.description) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value">${event.description}</div>
                    </div>
                `;
            }
            
            if (event.food && event.food.length > 0) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Food Details:</div>
                        <div class="detail-value">
                            ${event.food.map(foodItem => `
                                <div style="margin-bottom: 8px; padding: 8px; background: var(--primary-dark); border-radius: 4px;">
                                    <strong>${foodItem.name}</strong>
                                    ${foodItem.quantity_hint ? `<br><small>${foodItem.quantity_hint}</small>` : ''}
                                    ${foodItem.cuisine ? `<br><span class="badge badge-cuisine" style="margin-top: 4px; display: inline-block;">${foodItem.cuisine}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (event.organizer) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Organizer:</div>
                        <div class="detail-value">${event.organizer}</div>
                    </div>
                `;
            }
            
            if (event.contacts && event.contacts.length > 0) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Contacts:</div>
                        <div class="contacts">
                            ${event.contacts.map(contact => `
                                <div class="contact">
                                    <span>${contact.name || 'Unknown'}</span>
                                    ${contact.email ? `<a href="mailto:${contact.email}" class="contact-email">${contact.email}</a>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (event.urls && event.urls.length > 0) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Links:</div>
                        <div class="urls">
                            ${event.urls.map(url => `
                                <a href="${normalizeUrl(url)}" target="_blank" class="url-link">${url}</a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (event.confidence) {
                const confDetails = [];
                if (event.confidence.category !== null) confDetails.push(`Category: ${Math.round(event.confidence.category * 100)}%`);
                if (event.confidence.cuisine !== null) confDetails.push(`Cuisine: ${Math.round(event.confidence.cuisine * 100)}%`);
                if (event.confidence.overall !== null) confDetails.push(`Overall: ${Math.round(event.confidence.overall * 100)}%`);
                
                if (confDetails.length > 0) {
                    details += `
                        <div class="detail-item">
                            <div class="detail-label">Confidence Scores:</div>
                            <div class="detail-value">${confDetails.join(' • ')}</div>
                        </div>
                    `;
                }
            }
            
            if (event.mailing_list) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Mailing List:</div>
                        <div class="detail-value">${event.mailing_list}</div>
                    </div>
                `;
            }
            
            if (event.source_subject) {
                details += `
                    <div class="detail-item">
                        <div class="detail-label">Original Subject:</div>
                        <div class="detail-value">${event.source_subject}</div>
                    </div>
                `;
            }
            
            return details;
        }
        
        function normalizeUrl(url) {
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            return `https://${url}`;
        }
        
        function toggleEvent(card) {
            card.classList.toggle('expanded');
        }

        async function addToGoogleCalendar(eventId, eventTitle) {
            try {
                // Show loading state
                const button = document.querySelector(`[onclick*="${eventId}"]`);
                if (button) {
                    button.innerHTML = '⏳ Loading...';
                    button.disabled = true;
                }

                // Get event details from the current events
                const eventData = allEvents.find(e => e.source_message_id === eventId);
                if (!eventData) {
                    throw new Error('Event not found');
                }

                // Build Google Calendar URL
                const googleCalendarUrl = buildGoogleCalendarUrl(eventData);
                
                // Open Google Calendar in new tab
                window.open(googleCalendarUrl, '_blank');

                // Show success message
                showStatus(`✅ Opening Google Calendar for: ${eventTitle}`, 'success');

            } catch (error) {
                console.error('Error opening Google Calendar:', error);
                showStatus(`❌ Error opening Google Calendar: ${error.message}`, 'error');
            } finally {
                // Reset button state
                const button = document.querySelector(`[onclick*="${eventId}"]`);
                if (button) {
                    button.innerHTML = '📅 Add to Calendar';
                    button.disabled = false;
                }
            }
        }

        function buildGoogleCalendarUrl(event) {
            // Format date and time for Google Calendar
            const formatDate = (dateStr, timeStr) => {
                if (!dateStr) return '';
                
                // Parse date (YYYY-MM-DD format)
                const [year, month, day] = dateStr.split('-');
                
                if (!timeStr) {
                    // All-day event
                    return `${year}${month}${day}`;
                }
                
                // Parse time (HH:MM format)
                const [hour, minute] = timeStr.split(':');
                
                // Create date in local timezone
                const date = new Date(year, month - 1, day, parseInt(hour), parseInt(minute));
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const formatDateTime = (dateStr, timeStr, endTimeStr) => {
                if (!dateStr) return '';
                
                const [year, month, day] = dateStr.split('-');
                
                if (!timeStr) {
                    // All-day event - end date is next day
                    const endDate = new Date(year, month - 1, parseInt(day) + 1);
                    return {
                        start: `${year}${month}${day}`,
                        end: endDate.toISOString().split('T')[0].replace(/-/g, '')
                    };
                }
                
                // Parse time
                const [hour, minute] = timeStr.split(':');
                
                // Create start date
                const startDate = new Date(year, month - 1, day, parseInt(hour), parseInt(minute));
                
                // Calculate end date (default 1 hour if no end time)
                let endDate;
                if (endTimeStr) {
                    const [endHour, endMinute] = endTimeStr.split(':');
                    endDate = new Date(year, month - 1, day, parseInt(endHour), parseInt(endMinute));
                } else {
                    endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // 1 hour later
                }
                
                return {
                    start: startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z',
                    end: endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'
                };
            };

            // Build description with all event details
            let description = '';
            if (event.description) {
                description += event.description + '\n\n';
            }
            
            if (event.food && event.food.length > 0) {
                description += 'Food: ';
                description += event.food.map(item => {
                    let foodStr = item.name;
                    if (item.quantity_hint) foodStr += ` (${item.quantity_hint})`;
                    if (item.cuisine) foodStr += ` [${item.cuisine}]`;
                    return foodStr;
                }).join(', ') + '\n\n';
            }
            
            if (event.urls && event.urls.length > 0) {
                description += 'Links: ' + event.urls.join(', ') + '\n\n';
            }
            
            if (event.organizer) {
                description += `Organizer: ${event.organizer}\n\n`;
            }
            
            description += `Source: ${event.mailing_list || 'Mailing List'}`;

            // Build the Google Calendar URL
            const dateTimeRange = formatDateTime(event.date_start, event.time_start, event.time_end);
            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: event.title,
                dates: dateTimeRange.start + '/' + dateTimeRange.end,
                details: description,
                location: event.location || '',
                trp: 'false'
            });

            return `https://calendar.google.com/calendar/render?${params.toString()}`;
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            // Add a small delay for loading messages to be visible
            if (type === 'loading') {
                return new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        // Navigation functions
        function showHomePage() {
            currentPage = 'home';
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('aboutPage').classList.remove('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const homeLink = document.querySelector('[data-page="home"]');
            if (homeLink) homeLink.classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showAboutPage() {
            currentPage = 'about';
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('aboutPage').classList.add('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const aboutLink = document.querySelector('[data-page="about"]');
            if (aboutLink) aboutLink.classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>